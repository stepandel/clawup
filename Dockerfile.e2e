# Lightweight test image for CI e2e tests.
# Mimics the structure of the Nix-built clawup-openclaw image
# without requiring a full Nix build.
FROM ubuntu:24.04

# No curl â€” prevents the entrypoint from installing the real Claude CLI,
# so the stub binary is used instead for predictable test behavior.
RUN apt-get update && apt-get install -y --no-install-recommends \
    bash coreutils gzip git ca-certificates jq python3 \
  && rm -rf /var/lib/apt/lists/*

# Create openclaw user (uid 1000) matching the Nix image.
# Remove existing uid-1000 user (ubuntu) first if present.
RUN existing=$(getent passwd 1000 | cut -d: -f1) \
  && [ -n "$existing" ] && userdel -r "$existing" || true \
  && useradd -m -u 1000 -s /bin/bash openclaw \
  && mkdir -p /home/openclaw/.openclaw/workspace \
  && chown -R openclaw:openclaw /home/openclaw

# Stub binaries so the entrypoint script doesn't fail with set -e.
# "openclaw gateway" sleeps forever to keep the container alive.
# "openclaw devices approve" is a no-op.
# "claude --version" returns a fake version.
RUN mkdir -p /usr/local/bin \
  && printf '#!/bin/bash\nif [ "$1" = "gateway" ]; then\n  exec sleep infinity\nelif [ "$1" = "devices" ]; then\n  exit 0\nelif [ "$1" = "plugins" ]; then\n  exit 0\nfi\n' > /usr/local/bin/openclaw \
  && chmod +x /usr/local/bin/openclaw \
  && printf '#!/bin/bash\nif [ "$1" = "--version" ]; then echo "claude-code 1.0.0-e2e-stub"; exit 0; fi\necho "not authenticated"; exit 1\n' > /usr/local/bin/claude \
  && chmod +x /usr/local/bin/claude \
  && mkdir -p /home/openclaw/.local/bin \
  && ln -s /usr/local/bin/claude /home/openclaw/.local/bin/claude \
  && chown -R openclaw:openclaw /home/openclaw/.local \
  && printf '#!/bin/bash\nexit 0\n' > /usr/local/bin/clawhub \
  && chmod +x /usr/local/bin/clawhub

USER openclaw
WORKDIR /home/openclaw
ENV HOME=/home/openclaw
ENV PATH="/home/openclaw/.local/bin:/usr/local/bin:${PATH}"

EXPOSE 18789

CMD ["/bin/bash"]
